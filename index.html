<style>
    /* עיצוב נוסף לטיימרים ברשימה */
    .task-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-bottom: 2px solid #f0f0f0;
        background: #fff;
    }
    .task-info { text-align: right; flex-grow: 1; }
    .task-name { font-size: 1.5em; font-weight: bold; display: block; }
    .task-timer { 
        font-family: monospace; 
        color: #e67e22; 
        font-size: 1.2em; 
        background: #fdf2e9; 
        padding: 2px 8px; 
        border-radius: 5px;
    }
    .btn-done {
        margin-right: 15px;
        padding: 10px 15px;
        font-size: 1.1em;
        border-radius: 8px;
        cursor: pointer;
        border: 2px solid #2ecc71;
        background: white;
        color: #27ae60;
    }
    .btn-done.completed {
        background: #2ecc71;
        color: white;
    }
</style>

<div class="card">
    <h2>משימות להיום</h2>
    <div id="tasks-list"></div>
</div>

<script>
    let tasks = [];

    async function loadTasks() {
        const res = await fetch('config.json?v=' + Date.now());
        const config = await res.json();
        tasks = config.tasks;
        renderTasks();
    }

    function renderTasks() {
        const list = document.getElementById('tasks-list');
        list.innerHTML = tasks.map((task, index) => `
            <div class="task-item">
                <div class="task-info">
                    <span class="task-name">${task.label} בשעה ${task.time}</span>
                    <span class="task-timer" id="timer-${index}">--:--:--</span>
                </div>
                <button class="btn-done" id="btn-${index}" onclick="markAsDone(${index}, '${task.label}')">בוצע</button>
            </div>
        `).join('');
        
        startTaskTimers();
    }

    function startTaskTimers() {
        setInterval(() => {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];

            tasks.forEach((task, index) => {
                const target = new Date(`${dateStr}T${task.time}:00`);
                const diff = target - now;
                const timerEl = document.getElementById(`timer-${index}`);

                if (diff > 0) {
                    const hrs = Math.floor(diff / 3600000);
                    const mins = Math.floor((diff % 3600000) / 60000);
                    const secs = Math.floor((diff % 60000) / 1000);
                    timerEl.innerText = `עוד ${hrs}:${mins < 10 ? '0' : ''}${mins}:${secs < 10 ? '0' : ''}${secs}`;
                } else {
                    timerEl.innerText = "זמן המשימה הגיע";
                    timerEl.style.color = "#e74c3c";
                }
            });
        }, 1000);
    }

    function markAsDone(index, label) {
        const btn = document.getElementById(`btn-${index}`);
        btn.innerText = "✓ בוצע";
        btn.classList.add('completed');
        btn.disabled = true;
        
        // דיווח לוובהוק
        fetch(WEBHOOK_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ type: 'task_completed', task: label, time: new Date().toISOString() })
        });
    }

    loadTasks();
</script>
