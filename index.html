<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>מעקב שתייה במשך היום</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f4f7;
  text-align: center;
  padding: 30px;
}
h1 { font-size: 52px; margin-bottom: 10px; }
#instruction { font-size: 28px; font-weight: bold; margin-bottom: 20px; color: #1a1a1a; }
#status { font-size: 40px; margin-bottom: 10px; }
#overflow { font-size: 32px; color: red; margin-bottom: 20px; }
.cups { display: flex; justify-content: center; gap: 25px; margin-bottom: 40px; }
.cup { width: 90px; height: 180px; border: 6px solid #000; border-radius: 0 0 25px 25px; background: white; position: relative; }
.fill { position: absolute; bottom: 0; width: 100%; background: #4da6ff; transition: height 0.3s; }
.marker { position: absolute; width: 100%; height: 2px; background: #aaa; left: 0; }
.buttons { display: flex; justify-content: center; gap: 25px; margin-bottom: 30px; }
button { font-size: 34px; padding: 22px 36px; border-radius: 16px; border: none; background: #2e7df6; color: white; }
h2 { font-size: 36px; margin-top: 40px; }
.log { font-size: 26px; background: white; margin: 10px auto; padding: 12px; width: 80%; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
</style>
</head>
<body>

<h1>מעקב שתייה במשך היום</h1>
<div id="instruction">הוראת רופא מומחה: יש להגביל את כמות שתיית הנוזלים, להקפיד לא לשתות מעבר למגבלה היומית ולעקוב אחר כמות כל כוס</div>

<div id="status"></div>
<div id="overflow"></div>
<div class="cups" id="cups"></div>

<div class="buttons">
  <button onclick="add(50)">50 מ״ל</button>
  <button onclick="add(100)">100 מ״ל</button>
  <button onclick="add(200)">200 מ״ל</button>
</div>

<h2>הסטוריית שתייה של היום</h2>
<div id="log"></div>

<script>
const CUP_SIZE = 200;
let DAILY_LIMIT = 1000;
let total = 0;
let log = [];

const INIT_WEBHOOK_URL = "https://hook.integrator.boost.space/n33w53hpsj1ar34x25b9psqwx8sbcj0n";
const UPDATE_WEBHOOK_URL = "https://hook.integrator.boost.space/uhlqmxm4tzn2rpy04qga5lcip6o5rnbs";

// קריאה ראשונית
async function initData() {
  try {
    const res = await fetch(INIT_WEBHOOK_URL);
    if (!res.ok) throw new Error("Network response was not ok");
    const data = await res.json();
    if (!data) throw new Error("No data returned from webhook");

    total = data.totalDrank || 0;
    DAILY_LIMIT = data.dailyLimit || 1000;
    log = data.log || [];
    render();
  } catch (err) {
    console.error("Failed to fetch initial data:", err);
    // במקרה של כשל, נשאר עם הערכים הקיימים ונמשיך
    render();
  }
}

window.addEventListener('load', initData);

function render() {
  document.getElementById("status").innerText = total + " מתוך " + DAILY_LIMIT + " מ״ל";
  const overflowAmount = total - DAILY_LIMIT;
  document.getElementById("overflow").innerText = overflowAmount > 0 ? "חריגה: " + overflowAmount + " מ״ל" : "";
  renderCups();
  renderLog();
}

function renderCups() {
  const cups = document.getElementById("cups");
  cups.innerHTML = "";
  const numCups = Math.ceil(DAILY_LIMIT / CUP_SIZE);
  const percent = total / DAILY_LIMIT;
  const overflow = total > DAILY_LIMIT;

  for (let i = 0; i < numCups; i++) {
    const cup = document.createElement("div");
    cup.className = "cup";

    for (let y = 10; y < CUP_SIZE; y += 10) {
      const mark = document.createElement("div");
      mark.className = "marker";
      mark.style.bottom = (y / CUP_SIZE * 100) + "%";
      cup.appendChild(mark);
    }

    const label = document.createElement("div");
    label.style.position = "absolute";
    label.style.bottom = "-25px";
    label.style.width = "100%";
    label.style.textAlign = "center";
    label.style.fontWeight = "bold";
    label.innerText = "200 מ״ל";
    cup.appendChild(label);

    const fill = document.createElement("div");
    fill.className = "fill";
    fill.style.height = Math.max(0, Math.min(1, percent * numCups - i)) * 100 + "%";
    cup.appendChild(fill);

    cups.appendChild(cup);
  }

  if (overflow) {
    const extraCup = document.createElement("div");
    extraCup.className = "cup";
    const redFill = document.createElement("div");
    redFill.className = "fill";
    redFill.style.height = "100%";
    redFill.style.background = "red";
    extraCup.appendChild(redFill);

    const label = document.createElement("div");
    label.style.position = "absolute";
    label.style.bottom = "-25px";
    label.style.width = "100%";
    label.style.textAlign = "center";
    label.style.fontWeight = "bold";
    label.innerText = "200 מ״ל";
    extraCup.appendChild(label);

    cups.appendChild(extraCup);
  }
}

function renderLog() {
  const box = document.getElementById("log");
  box.innerHTML = "";
  log.forEach(entry => {
    const div = document.createElement("div");
    div.className = "log";
    div.innerText = `שתיית ${entry.amount} מ״ל בשעה ${entry.time}`;
    box.appendChild(div);
  });
}

function add(amount) {
  total += amount;
  const now = new Date();
  const time = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
  const date = now.getFullYear() + "-" + (now.getMonth()+1).toString().padStart(2,'0') + "-" + now.getDate().toString().padStart(2,'0');

  log.unshift({ amount, time });
  render();

  fetch(UPDATE_WEBHOOK_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ amount: amount, date: date, time: time })
  }).catch(err => console.error("Update Webhook failed:", err));
}
</script>

</body>
</html>
