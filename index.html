<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×¢×•×’×Ÿ ××¦×™××•×ª â€“ Care Dashboard</title>

  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 connect-src https://api.airtable.com;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self';
                 img-src 'self' data:;">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      color: #000;
      padding: 20px;
    }
    h1 { font-size: 36px; margin-bottom: 10px; }
    .date { font-size: 22px; margin-bottom: 20px; }

    .cards {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      font-size: 22px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      min-width: 200px;
    }

    .water {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .cup {
      width: 60px;
      height: 120px;
      border: 2px solid #333;
      border-radius: 0 0 10px 10px;
      position: relative;
      overflow: hidden;
      background: #fff;
    }
    .fill {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 0%;
      background: #4da6ff;
      transition: height 0.5s;
    }
    .alert .fill { background: red; }
    .alert-text { color: red; font-weight: bold; }
  </style>
</head>

<body>

<h1>×¢×•×’×Ÿ ××¦×™××•×ª</h1>
<div class="date" id="date"></div>

<div class="cards">
  <div class="card">
    ğŸ•’ ××¨×•×—×” ×”×‘××” ×‘×¢×•×“:<br>
    <strong id="mealTimer">â€”</strong>
  </div>

  <div class="card">
    ğŸ’§ ×©×ª×™×™×” ×”×™×•×:<br>
    <span id="drinkText"></span>
  </div>
</div>

<div class="water" id="waterCups"></div>

<h2>×”×•×“×¢×•×ª ×—×©×•×‘×•×ª</h2>
<div class="cards" id="messages"></div>

<script>
/* ================= CONFIG ================= */
const AIRTABLE_TOKEN = "patYROlXXsnMS6UGc.35db62b17c05cb389113fb25139404a902b3e173ddf9e4977b820b886f472ba3";
const BASE_ID = "tbldJESVs1InvDcQn";
/* ========================================= */

const headers = {
  "Authorization": `Bearer ${AIRTABLE_TOKEN}`
};

function setDates() {
  const now = new Date();
  const hebrew = new Intl.DateTimeFormat('he-u-ca-hebrew',
    { weekday:'long', day:'numeric', month:'long', year:'numeric' }
  ).format(now);

  const gregorian = now.toLocaleDateString('he-IL');
  document.getElementById('date').innerText = `${hebrew} | ${gregorian}`;
}

async function fetchSettings() {
  const res = await fetch(
    `https://api.airtable.com/v0/${BASE_ID}/Settings`,
    { headers }
  );
  const data = await res.json();
  return data.records[0].fields;
}

async function fetchMessages() {
  const res = await fetch(
    `https://api.airtable.com/v0/${BASE_ID}/Messages?filterByFormula=Display=1`,
    { headers }
  );
  const data = await res.json();
  return data.records;
}

function updateWater(total, limit) {
  const percent = Math.min(total / limit, 1);
  const cups = document.getElementById('waterCups');
  cups.innerHTML = "";

  const alert = total > limit;

  for (let i = 0; i < 5; i++) {
    const cup = document.createElement('div');
    cup.className = 'cup' + (alert ? ' alert' : '');

    const fill = document.createElement('div');
    fill.className = 'fill';

    const fillLevel = Math.max(0, percent * 5 - i);
    fill.style.height = `${Math.min(fillLevel,1) * 100}%`;

    cup.appendChild(fill);
    cups.appendChild(cup);
  }

  const text = document.getElementById('drinkText');
  text.innerText = `${total} / ${limit} ×"×œ`;
  if (alert) text.className = 'alert-text';
}

function updateMealTimer(time) {
  const target = new Date(time);
  setInterval(() => {
    const diff = target - new Date();
    if (diff <= 0) {
      document.getElementById('mealTimer').innerText = "×¢×›×©×™×•";
      return;
    }
    const m = Math.floor(diff / 60000);
    const s = Math.floor((diff % 60000) / 1000);
    document.getElementById('mealTimer').innerText = `${m}:${s.toString().padStart(2,'0')}`;
  }, 1000);
}

async function load() {
  try {
    setDates();

    const settings = await fetchSettings();
    updateWater(settings.Total_Drank, settings.Daily_Limit);
    updateMealTimer(settings.Next_Meal);

    const msgs = await fetchMessages();
    const box = document.getElementById('messages');
    box.innerHTML = "";

    msgs.forEach(m => {
      const d = document.createElement('div');
      d.className = 'card';
      d.innerText = m.fields.Text;
      box.appendChild(d);
    });

  } catch (e) {
    document.body.innerHTML = "<h2>âš ï¸ ×©×’×™××ª ×—×™×‘×•×¨. × × ×œ× ×¡×•×ª ×××•×—×¨ ×™×•×ª×¨.</h2>";
  }
}

load();
setInterval(load, 60000);
</script>

</body>
</html>
