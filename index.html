<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>לוח שנה ומעקב</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; text-align: center; padding: 20px; direction: rtl; }
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; max-width: 700px; margin-left: auto; margin-right: auto; }
        .date-header { font-size: 1.8em; color: #2c3e50; font-weight: bold; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .glass-container { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
        .glass { width: 50px; height: 80px; border: 3px solid #333; border-top: none; position: relative; border-radius: 0 0 10px 10px; background: #fff; overflow: hidden; }
        .water { position: absolute; bottom: 0; width: 100%; background: #3498db; transition: height 1s; }
        .over-limit { background: #e74c3c !important; } /* צבע אדום אם עבר את המכסה */
        .msg-list { text-align: right; font-size: 1.3em; list-style: none; padding: 0; }
        .msg-item { background: #fff3cd; margin: 10px 0; padding: 15px; border-right: 5px solid #ffc107; border-radius: 5px; }
        .timer { font-size: 2.5em; color: #d35400; font-weight: bold; }
    </style>
</head>
<body>

    <div class="card">
        <div id="hebrew-date" class="date-header"></div>
        <div id="english-date" style="font-size: 1.2em; color: #7f8c8d;"></div>
    </div>

    <div id="messages-container" class="card" style="display:none;">
        <ul id="msg-list" class="msg-list"></ul>
    </div>

    <div class="card">
        <h2>מצב שתייה יומי</h2>
        <div id="glasses" class="glass-container"></div>
        <div id="drank-info" style="font-size: 1.4em; font-weight: bold;">טוען נתונים...</div>
    </div>

    <div class="card">
        <h3>זמן לארוחה הבאה:</h3>
        <div id="timer" class="timer">--:--</div>
    </div>

    <script>
        const TOKEN = 'patB4mP3wrsCwp5QU.ef79ab511e1080eae72b4d05ec10b9a899d1502f02632cf7e92d54e783b711d0'; 
        const BASE_ID = 'tblAPuqJiDOBqi20A';

        async function updateData() {
            try {
                // 1. קבלת הגדרות (שתייה וארוחות)
                const settingsRes = await fetch(`https://api.airtable.com/v0/${BASE_ID}/Settings`, {
                    headers: { Authorization: `Bearer ${TOKEN}` }
                });
                const settingsData = await settingsRes.json();
                const settings = settingsData.records[0].fields;

                // 2. קבלת הודעות
                const msgRes = await fetch(`https://api.airtable.com/v0/${BASE_ID}/Messages?filterByFormula={Display}=1`, {
                    headers: { Authorization: `Bearer ${TOKEN}` }
                });
                const msgData = await msgRes.json();

                renderDashboard(settings, msgData.records);
            } catch (e) { console.error("שגיאה במשיכת נתונים", e); }
        }

        function renderDashboard(settings, messages) {
            // תאריכים
            const now = new Date();
            document.getElementById('english-date').innerText = now.toLocaleDateString('he-IL');
            document.getElementById('hebrew-date').innerText = new Intl.DateTimeFormat('he-IL-u-ca-hebrew', {dateStyle: 'full'}).format(now);

            // הודעות
            const msgList = document.getElementById('msg-list');
            msgList.innerHTML = '';
            if(messages.length > 0) {
                document.getElementById('messages-container').style.display = 'block';
                messages.forEach(m => {
                    const li = document.createElement('li');
                    li.className = 'msg-item';
                    li.innerText = m.fields.Text;
                    msgList.appendChild(li);
                });
            }

            // שתייה
            const drank = settings.Total_Drank || 0;
            const limit = settings.Daily_Limit || 800;
            const remaining = limit - drank;
            
            document.getElementById('drank-info').innerHTML = `שתית ${drank} מ"ל. <br> ` + 
                (remaining >= 0 ? `נותרו עוד ${remaining} מ"ל.` : `<span style="color:red">עברת את המותר ב-${Math.abs(remaining)} מ"ל!</span>`);

            renderGlasses(drank, limit);
            startTimer(settings.Next_Meal);
        }

        function renderGlasses(drank, limit) {
            const container = document.getElementById('glasses');
            container.innerHTML = '';
            const numGlasses = 5;
            const perGlass = limit / numGlasses;

            for (let i = 0; i < numGlasses; i++) {
                const glass = document.createElement('div');
                glass.className = 'glass';
                const water = document.createElement('div');
                water.className = 'water';
                if (drank > limit) water.classList.add('over-limit');
                
                let fill = Math.min(Math.max((drank - (i * perGlass)) / perGlass, 0), 1) * 100;
                water.style.height = fill + '%';
                glass.appendChild(water);
                container.appendChild(glass);
            }
        }

        function startTimer(target) {
            if(!target) return;
            const mealTime = new Date(target).getTime();
            const timerDiv = document.getElementById('timer');
            
            const interval = setInterval(() => {
                const diff = mealTime - new Date().getTime();
                if(diff <= 0) { timerDiv.innerText = "בתיאבון!"; clearInterval(interval); return; }
                const mins = Math.floor(diff / 60000);
                const secs = Math.floor((diff % 60000) / 1000);
                timerDiv.innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }, 1000);
        }

        updateData();
        setInterval(updateData, 30000); // רענון חצי דקה
    </script>
</body>
</html>
