<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline'; connect-src 'self' https://api.airtable.com;">
    <title>לוח מעקב אישי</title>
    <style>
        :root { --main-blue: #3498db; --warning-red: #e74c3c; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); margin: 0; padding: 20px; direction: rtl; }
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); margin-bottom: 25px; max-width: 800px; margin-left: auto; margin-right: auto; }
        .date-section { border-bottom: 4px solid var(--main-blue); padding-bottom: 15px; }
        .hebrew-date { font-size: 3em; font-weight: bold; color: #2c3e50; display: block; }
        .english-date { font-size: 1.5em; color: #7f8c8d; }
        .msg-item { background: #fff3cd; border-right: 8px solid #f1c40f; padding: 20px; margin: 15px 0; border-radius: 10px; font-size: 1.8em; text-align: right; font-weight: bold; color: #856404; }
        .glass-container { display: flex; justify-content: center; gap: 20px; margin: 30px 0; flex-wrap: wrap; }
        .glass { width: 70px; height: 110px; border: 4px solid #333; border-top: none; position: relative; border-radius: 0 0 15px 15px; background: #fff; overflow: hidden; }
        .water { position: absolute; bottom: 0; width: 100%; background: var(--main-blue); transition: height 1.5s ease-in-out; }
        .water.danger { background: var(--warning-red); }
        .info-text { font-size: 1.8em; font-weight: bold; margin-top: 15px; }
        .timer-label { font-size: 1.5em; color: #2c3e50; }
        .timer-digits { font-size: 4em; font-weight: bold; color: #d35400; font-family: monospace; }
    </style>
</head>
<body>

    <div class="card date-section">
        <span id="heb-date" class="hebrew-date">טוען תאריך...</span>
        <span id="eng-date" class="english-date"></span>
    </div>

    <div id="messages-area"></div>

    <div class="card">
        <div class="timer-label">מצב שתייה יומי:</div>
        <div id="glasses-box" class="glass-container"></div>
        <div id="drinking-summary" class="info-text">מחשב נתונים...</div>
    </div>

    <div class="card">
        <div class="timer-label">זמן לארוחה הבאה:</div>
        <div id="timer" class="timer-digits">--:--</div>
    </div>

    <script>
        const CONFIG = {
            TOKEN: 'patYROlXXsnMS6UGc.35db62b17c05cb389113fb25139404a902b3e173ddf9e4977b820b886f472ba3',
            BASE_ID: 'tblAPuqJiDOBqi20A',
            TABLES: { SETTINGS: 'Settings', MESSAGES: 'Messages' }
        };

        function updateTime() {
            const now = new Date();
            const hebOptions = { calendar: 'hebrew', dateStyle: 'full' };
            document.getElementById('heb-date').innerText = new Intl.DateTimeFormat('he-IL-u-ca-hebrew', hebOptions).format(now);
            document.getElementById('eng-date').innerText = now.toLocaleDateString('he-IL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        async function fetchData() {
            try {
                // משיכת הגדרות
                const setRes = await fetch(`https://api.airtable.com/v0/${CONFIG.BASE_ID}/${CONFIG.TABLES.SETTINGS}`, {
                    headers: { Authorization: `Bearer ${CONFIG.TOKEN}` }
                });
                const setData = await setRes.json();
                const settings = setData.records[0].fields;

                // משיכת הודעות (רק אלו שמסומנות ב-Display)
                const msgRes = await fetch(`https://api.airtable.com/v0/${CONFIG.BASE_ID}/${CONFIG.TABLES.MESSAGES}?filterByFormula={Display}=1`, {
                    headers: { Authorization: `Bearer ${CONFIG.TOKEN}` }
                });
                const msgData = await msgRes.json();

                renderUI(settings, msgData.records);
            } catch (err) {
                console.error("Airtable Error:", err);
            }
        }

        function renderUI(settings, messageRecords) {
            // 1. רינדור הודעות
            const msgArea = document.getElementById('messages-area');
            msgArea.innerHTML = '';
            messageRecords.forEach(rec => {
                const div = document.createElement('div');
                div.className = 'msg-item';
                div.innerText = rec.fields.Text;
                msgArea.appendChild(div);
            });

            // 2. רינדור שתייה
            const drank = settings.Total_Drank || 0;
            const limit = settings.Daily_Limit || 1000;
            const summary = document.getElementById('drinking-summary');
            
            summary.innerHTML = `שתית ${drank} מ"ל מתוך ${limit} מ"ל מותרים.`;
            if (drank > limit) {
                summary.innerHTML += `<br><span style="color:var(--warning-red)">לתשומת לבך: עברת את המכסה!</span>`;
            }

            const container = document.getElementById('glasses-box');
            container.innerHTML = '';
            const numGlasses = 5;
            const mlPerGlass = limit / numGlasses;

            for (let i = 0; i < numGlasses; i++) {
                const glass = document.createElement('div');
                glass.className = 'glass';
                const water = document.createElement('div');
                water.className = 'water' + (drank > limit ? ' danger' : '');
                let fill = Math.min(Math.max((drank - (i * mlPerGlass)) / mlPerGlass, 0), 1) * 100;
                water.style.height = fill + '%';
                glass.appendChild(water);
                container.appendChild(glass);
            }

            // 3. טיימר
            if (settings.Next_Meal) setupTimer(settings.Next_Meal);
        }

        let timerInterval;
        function setupTimer(targetTime) {
            if (timerInterval) clearInterval(timerInterval);
            const target = new Date(targetTime).getTime();
            
            timerInterval = setInterval(() => {
                const now = new Date().getTime();
                const diff = target - now;
                const display = document.getElementById('timer');

                if (diff <= 0) {
                    display.innerText = "בתיאבון!";
                    clearInterval(timerInterval);
                } else {
                    const mins = Math.floor(diff / 60000);
                    const secs = Math.floor((diff % 60000) / 1000);
                    display
